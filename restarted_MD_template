# 3D LJ Poiseuille flow simulation

read_restart restart_$i.lmp

neighbor	0.3 bin
neigh_modify	delay 5

# create geometry

lattice		hcp 0.5
region		box block 0 20 0 $yhi 0 10

mass		1 1.0
mass		2 1.0
mass		3 1.0

# LJ potentials

pair_style	lj/cut 1.0
pair_coeff	* * 1.0 1.0 1.0

# define groups

region	     1 block INF INF INF 1.0 INF INF
group	     lower region 1
region	     2 block INF INF $ylo INF INF INF
group	     upper region 2
group	     boundary union lower upper
group	     liquid subtract all boundary

set	     group lower type 2
set	     group upper type 3

# temperature settings

compute      mobile liquid temp
velocity     liquid create 1.0 100 temp mobile
fix          1 all nve
fix          2 liquid temp/rescale 200 1.0 2.0 0.02 1.0
fix_modify   2 temp mobile

# Poiseuille flow
variable force internal 0.0

velocity     boundary set 0.0 0.0 0.0
fix	     4 lower setforce 0.0 0.0 0.0
fix	     5 upper setforce 0.0 0.0 0.0
fix	     6 liquid addforce v_force 0.0 0.0

# Compute total momentum
compute total_mom liquid momentum
# Compute mass flow rate in x
variable mass_flow_x equal "c_total_mom[1]/lx"

# Run

timestep	0.003
thermo		500
thermo_modify   temp mobile

variable shutdown1 internal 0

fix		cfd all mui/connect md$i $i
fix		fetchforce all mui/fetch_param cfd $i force force EVERY 10
fix		push_mass_flow all mui/push cfd $i PARAM mass_flow_x mass_flow_x EVERY 10
fix		terminate all mui/shutdown EVERY 10
fix		halt all halt 1 v_shutdown1 > 0 error soft

reset_timestep  $t
run		500
write_restart restart_$i.lmp
